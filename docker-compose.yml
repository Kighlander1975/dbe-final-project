services:
    # MariaDB Datenbank
    database:
        image: mariadb:10.11
        container_name: stechen_database
        restart: unless-stopped
        environment:
            MYSQL_ROOT_PASSWORD: root_password
            MYSQL_DATABASE: stechen_db
            MYSQL_USER: stechen_user
            MYSQL_PASSWORD: stechen_pass
        volumes:
            - database_data:/var/lib/mysql
            - ./database/init:/docker-entrypoint-initdb.d
        ports:
            - "3307:3306"
        networks:
            - stechen_network
        healthcheck:
            test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
            interval: 10s
            timeout: 5s
            retries: 5

    # phpMyAdmin
    phpmyadmin:
        image: phpmyadmin:latest
        container_name: stechen_phpmyadmin
        restart: unless-stopped
        environment:
            PMA_HOST: database
            PMA_PORT: 3306
            PMA_USER: stechen_user
            PMA_PASSWORD: stechen_pass
            MYSQL_ROOT_PASSWORD: root_password
            UPLOAD_LIMIT: 300M
        ports:
            - "8080:80"
        depends_on:
            database:
                condition: service_healthy
        networks:
            - stechen_network

    # Laravel Backend API
    backend:
        build:
            context: ./backend
            dockerfile: Dockerfile
        container_name: stechen_backend
        restart: unless-stopped
        working_dir: /var/www/html
        volumes:
            - ./backend:/var/www/html
        ports:
            - "8000:80"
        environment:
            DB_CONNECTION: mysql
            DB_HOST: database
            DB_PORT: 3306
            DB_DATABASE: stechen_db
            DB_USERNAME: stechen_user
            DB_PASSWORD: stechen_pass
        depends_on:
            database:
                condition: service_healthy
        networks:
            - stechen_network

    # React Frontend
    frontend:
        build:
            context: . # ‚Üê Root-Verzeichnis als Kontext!
            dockerfile: frontend.Dockerfile
        container_name: stechen_frontend
        ports:
            - "3000:3000"
        volumes:
            - ./frontend:/app
        networks:
            - stechen_network

networks:
    stechen_network:
        driver: bridge

volumes:
    database_data:
        driver: local
